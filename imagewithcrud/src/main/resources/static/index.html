<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ImagesWithCrud</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: #F8F7BA;
    }

    .main-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 80vh;
    }

    .btn-conatainer {
      padding: 8rem;
      background-color: #8cddb6;
      border-radius: 15px;
    }

    button {
      border-radius: 10px;
      padding: 0.5rem;
    }

    .imageContainer {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    img {
      width: 250px;
      height: 150px;
      border-radius: 15px;
      transition: transform 0.2s ease;
    }

    img:hover {
      transform: scale(1.05);
    }
  </style>
</head>

<body>
  <h2>Upload An Image</h2>

  <form id="uploadForm">
    <input type="file" id="fileinput">
    <button type="submit">Upload</button>
  </form>
  <p id="dispmessage"></p>
  <div class="main-container">
    <div class="btn-conatainer">
      <button id="getAllbtn">Get All Images</button><br>
      <button id="delbtn">Delete</button>
    </div>
  </div>

  <div class="imageContainer">

  </div>


  <!-- To delete an image we need to take the input from the user -->
  <div class="getContainer" style="display: none;">
    <label for="" id="label">Enter the Id: </label>
    <input type="num" id="numInp">
  </div>




  <script>
    // Important: Image data is byte[], so you cannot directly put it in HTML. 
    // You need to convert it to Base64.
    const baseurl = "http://localhost:8080/img";
    let imageContainer = document.querySelector(".imageContainer");  // where the images can be display
    let getAllImg = document.querySelector("#getAllbtn");
    async function FetchAllImages() {
      try {
        let response = await fetch(baseurl);
        let EachImg = await response.json();
        imageContainer.innerHTML = "";

        // we are using the For Each To Iterate The  Each Image in the Backend

        EachImg.forEach((img) => {
          let eachImageContainer = document.createElement("div");
          eachImageContainer.className = "image-container";
          eachImageContainer.style.display = "flex";
          eachImageContainer.style.flexDirection = "column";
          eachImageContainer.style.padding = "10px";





          // creating the each image element for the each there should be the sepparte
          let eachImgTag = document.createElement("img");
          eachImgTag.className = "img";
          eachImgTag.src = `data:${img.imagetype};base64,${img.imagedata}`;
          eachImgTag.style.width = "300px";
          eachImgTag.style.margin = "10px";




          let btnContainer = document.createElement("div");
          btnContainer.style.display = "flex";
          btnContainer.style.justifyContent = "flex-end"; // align buttons to right
          btnContainer.style.marginTop = "1px";
          btnContainer.style.gap = "8px";



          let editbutton = document.createElement("button");
          editbutton.className = "btn"
          editbutton.setAttribute("data-index", img.id);
          editbutton.textContent = "Edit";
          editbutton.style.borderRadius = "2px";
          editbutton.style.padding = "5px 10px";
          editbutton.style.cursor = "pointer";
          editbutton.style.border = "none";

          let deletebtn = document.createElement("button");
          deletebtn.className = "btn";
          deletebtn.setAttribute("data-index", img.id);
          deletebtn.textContent = "Delete";
          deletebtn.style.borderRadius = "2px";
          deletebtn.style.border = "none";
          deletebtn.style.padding = "5px 10px";
          deletebtn.style.cursor = "pointer";





          // from here onwards we are adding the addEventListener for the edit button and delete button


          editbutton.addEventListener("click", async () => {


            // Modal Creation 

            let modal = document.createElement("div");
            modal.id = `edit-modal-${img.id}`;
            modal.style.left = "0";
            modal.style.width = "100%";
            modal.style.height = "100%";
            modal.style.display = "flex";
            modal.style.alignItems = "center"
            modal.style.justifyContent = "center";


            // Form Container
            const card = document.createElement("div");
            card.style.padding = "20px";
            card.style.width = "400px";


            // title

            let title = document.createElement("h3");
            title.textContent = "Edit Image";


            // Current Image Preview
            let preview = document.createElement("img");
            // converting byte array too the browser readable format
            preview.src = `data:${img.imagetype};base64,${img.imagedata}`;
            preview.style.width = "100%";
            preview.style.height = "200px";
            preview.style.objectFit = "cover";
            preview.style.borderRadius = "5px";


            // image name

            let nameLabel = document.createElement("label");
            nameLabel.textContent = "Image Name";
            nameLabel.style.display = "block";




            const nameInput = document.createElement("input");
            nameInput.type = "text";
            nameInput.value = img.imagename || "";   // Prefill with current name
            nameInput.style.width = "100%";
            nameInput.style.padding = "8px";
            nameInput.style.marginTop = "5px";
            nameInput.style.boxSizing = "border-box";




            // File Input actula Uplading the image

            const fileinput = document.createElement("input");
            fileinput.type = "file";
            fileinput.accept = "image/*";       //only images are allowed
            fileinput.style.marginTop = "5px";

            let buttonContainer = document.createElement("div");
            buttonContainer.style.display = "flex";
            buttonContainer.style.display = "flex-end";
            buttonContainer.style.gap = "10px";

            //  Cancel button
            const cancelBtn = document.createElement("button");
            cancelBtn.textContent = "Cancel";
            cancelBtn.style.padding = "6px 12px";
            cancelBtn.style.cursor = "pointer";



            cancelBtn.addEventListener("click", () => {
              modal.remove(); //close the modal
            })


            // save Button


            const saveBtn = document.createElement("button");
            saveBtn.textContent = "Save";
            saveBtn.style.padding = "6px 12px";
            saveBtn.style.cursor = "pointer";
            saveBtn.style.backgroundColor = "#1976d2";
            saveBtn.style.color = "white";
            saveBtn.style.border = "none";
            saveBtn.style.borderRadius = "4px";





            saveBtn.addEventListener("click", async () => {
              let newname = nameInput.value;
              const file = fileinput.files[0] //get new file if choosen

              const formData = new FormData();

              formData.append("imagename", newname || img.imagename); // always send name
              if (file) formData.append("file", file);                // optional
                //appends the new name;


                try {
                  const response = await fetch(`${baseurl}/${img.id}`, {
                    method: "PUT",
                    body: formData
                  });

                  if (response.ok) {
                    // Update image preview in the UI
                    if (file) {
                      const reader = new FileReader();
                      reader.onload = () => {
                        eachImgTag.src = reader.result;   // Replace displayed image
                        img.imagename = newName;           // Update local data
                      };
                      reader.readAsDataURL(file);
                    } else {
                      img.imagename = newname;           // Only name changed
                    }

                    modal.remove(); // Close modal
                    alert("Image updated successfully!");
                  } else {
                    alert("Failed to update image");
                  }
                } catch (err) {
                  console.error(err);
                  alert("Error updating image");
                }
              
            })


            // adding all the data to the modal


            buttonContainer.appendChild(saveBtn);
            buttonContainer.appendChild(cancelBtn);

            card.appendChild(title);
            card.appendChild(preview);
             card.appendChild(nameLabel);
              card.appendChild(nameInput);
              card.appendChild(fileinput);
              card.appendChild(buttonContainer);



               modal.appendChild(card);


                document.body.appendChild(modal); 


          })



















          deletebtn.addEventListener("click", async () => {
            // alert(`  ${img.id} `);
            if (!confirm(`Are you Sure want delete the Image ${img.id} `)) {
              // FetchAllImages();
              return;
            }

            try {
              let resp = await fetch(`${baseurl}/${img.id}`, {
                method: 'DELETE'
              })
              let deletedata = await resp.text();

              if (resp.ok) {
                alert(`${deletedata}`);
                FetchAllImages();
              }
              else {
                alert(`${deletedata}`);
              }
            }
            catch (err) {
              console.error(err);
            }


          })






          // append the edit & delete btn in the btncontiner

          btnContainer.appendChild(editbutton);
          btnContainer.appendChild(deletebtn);


          // append the buttons the and the images to the main container
          eachImageContainer.appendChild(eachImgTag);
          eachImageContainer.appendChild(btnContainer);


          // append the entire image to the and buttons to the entire the image to the 
          imageContainer.appendChild(eachImageContainer);


        })
      }
      catch (err) {
        console.error("Error Fetching The  Images ", err);
      }
    }


    // FetchAllImages();

    getAllImg.addEventListener("click", FetchAllImages);


    // to Uplaod An Image Form
    let uploadForm = document.querySelector("#uploadForm");
    let message = document.querySelector("#dispmessage");

    let uploadurl="http://localhost:8080/img/upload";


    uploadForm.addEventListener("submit", async (e)=>{
      e.preventDefault();

      let fileinput = document.querySelector("#fileinput");
        const file = fileinput.files[0];   //the first  selected file 

      const formdata = new FormData();

      formdata.append("file",file);


      try{
        const response = await fetch(uploadurl,{
          method:'POST',
          body:formdata
        });


        if(response.ok){
          message.innerHTML=`Image Uplaoded Successfully`;
          // FetchAllImages();
        }
        else{
          message.innerHTML=`Geting some error to uploada the image`;
        }


      }
      catch(err){
        console.error(err);
      }


    })



    // to delete an image 

    let deletebtn = document.querySelector("#delbtn");
    // const deleteurl="http://localhost:8080/img/id"

    deletebtn.addEventListener("click", async () => {
      document.querySelector(".getContainer").style = "inline-block";
      let id = document.querySelector("#numInp").value;
      if (!id) {
        alert("please Enter the Id");
        return;
      }


      if (!confirm(`Are you sure u want to delete!! ${id}`)) {
        return;
      }

      try {

        const resp = await fetch(`${baseurl}/${id}`, {
          method: 'DELETE'
        });

        let data = await resp.text();
        alert(`${data}`);

        if (resp.ok) {
          alert(`${data}`);
          FetchAllImages();
        }
        else {
          alert(`${data}`);

        }



        // clearing the input 
        document.querySelector("#numInp").value = "";
        document.querySelector("#numInp").style.display = "none";
        document.querySelector("#label").style.display = "none";

      }
      catch (err) {
        console.error(err);
        alert("Deleteion failed");
      }

    })






  </script>
</body>

</html>